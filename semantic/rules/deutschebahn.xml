<?xml version="1.0" encoding="UTF-8"?>
<extractor>
    <filter header="From" match="buchungsbestaetigung@bahn.de"/>

    <!-- booking reference, assuming we find it before the itinery -->
    <variable match="(Online-Ticket|\n {8,}).*Auftragsnummer:\s*([A-Z0-9]{6})\n" name="bookingRef" value="${2}"/>
    <!-- find the itinery headers and extract the year number from there -->
    <variable name="year" match="Ihre Reiseverbindung[\S ]+(Hin|RÃ¼ck)fahrt am [0-9]{2}.[0-9]{2}.([0-9]{4}).*(?=\n)" value="${2}" repeat="true">

        <!-- domestic tickets with full-width itinery -->
        <variable name="dummy" match="  Reservierung">
            <!-- iterate over legs -->
            <class type="TrainReservation" match="\n(?=[A-Z])" repeat="true">
                <!-- stop when reaching the next itinery header -->
                <break match="^(?=Ihre Reiseverbindung)"/>
                <!-- stop when reaching the footer -->
                <break match="^(Wichtige Nutzungshinweise|Hinweise:)"/>

                <property name="reservationNumber" value="${bookingRef}"/>
                <class type="TrainTrip" name="reservationFor">

                    <class name="departureStation" type="TrainStation">
                        <property name="name" match="(.+?)  " value="${1}"/>
                    </class>
                    <variable name="depDate" match="([0-9]{2})\.([0-9]{2})\." value="${1} ${2}"/>
                    <property name="departureTime" match="ab ([0-9]{2}:[0-9]{2})" value="${depDate} ${year} ${1}" type="dateTime" format="dd MM yyyy hh:mm"/>
                    <property name="departurePlatform" match="^ {1,3}([^\n]*?)(  |\n)" value="${1}"/>
                    <property name="trainNumber" match=" +([^\n]*?)(?=(  |\n))" value="${1}"/>
                    <class name="arrivalStation" type="TrainStation">
                        <property name="name" match="\n(.+?)  " value="${1}"/>
                    </class>
                    <variable name="arrDate" match="([0-9]{2})\.([0-9]{2})\." value="${1} ${2}"/>
                    <property name="arrivalTime" match="an ([0-9]{2}:[0-9]{2})" value="${depDate} ${year} ${1}" type="dateTime" format="dd MM yyyy hh:mm"/>
                    <property name="arrivalPlatform" match="^ {1,3}([^\n]*?)(?=(  |\n))" value="${1}"/>
                </class>
            </class>
        </variable>

        <!-- international tickets with narrow itinery -->
        <variable name="dummy" match="(Produkte/Reservierung|Fahrt/Reservierung)">
            <!-- iterate over legs -->
            <class type="TrainReservation" match="\n      (?=[A-Z])" repeat="true">
                <!-- stop when reaching the next itinery header -->
                <break match="^(?= *Ihre Reiseverbindung)"/>
                <!-- stop when reaching the footer -->
                <break match="^ *(Wichtige Nutzungshinweise|Hinweise:)"/>
                <break match="^.*Seite \d / \d"/>

                <property name="reservationNumber" value="${bookingRef}"/>
                <class type="TrainTrip" name="reservationFor">

                    <class name="departureStation" type="TrainStation">
                        <property name="name" match="(.+?)  " value="${1}"/>
                    </class>
                    <variable name="depDate" match="([0-9]{2})\.([0-9]{2})\." value="${1} ${2}"/>
                    <property name="departureTime" match="ab ([0-9]{2}:[0-9]{2})" value="${depDate} ${year} ${1}" type="dateTime" format="dd MM yyyy hh:mm"/>
                    <property name="departurePlatform" match=" ([^\n]*?)(  |\n)" value="${1}"/>
                    <property name="trainNumber" match=" +([^,\n]*?)(?=(,|\n))" value="${1}"/>
                    <class name="arrivalStation" type="TrainStation">
                        <property name="name" match="\n +(.+?)  " value="${1}"/>
                    </class>
                    <variable name="arrDate" match="([0-9]{2})\.([0-9]{2})\." value="${1} ${2}"/>
                    <property name="arrivalTime" match="an ([0-9]{2}:[0-9]{2})" value="${depDate} ${year} ${1}" type="dateTime" format="dd MM yyyy hh:mm"/>
                    <property name="arrivalPlatform" match=" ([^\n]*?)(?=(  |\n))" value="${1}"/>
                </class>
            </class>
        </variable>

    </variable>
</extractor>
